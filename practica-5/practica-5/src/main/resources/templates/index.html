<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gr√°ficos en Tiempo Real</title>

    <!-- Librer√≠as necesarias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #121212, #1e1e1e);
            color: #ffffff;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffa726;
        }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-box {
            background: #1b1e24;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
            width: 40%;
            min-width: 450px;
        }

        .chart-box canvas {
            width: 100% !important;
            height: 400px !important;
        }
    </style>
</head>
<body>

<h1>üìä Datos de Sensores en Tiempo Real</h1>

<div id="graficos" class="chart-container"></div>

<script>
    Chart.register('chartjs-adapter-luxon');

    document.addEventListener("DOMContentLoaded", function () {
        console.log("‚úÖ DOM completamente cargado. Iniciando WebSockets...");
        iniciarWebSocket();
    });

    const sensores = {}; // Objeto para almacenar gr√°ficos por sensor

    function crearGrafico(sensorId, tipo) {
        if (!sensorId) {
            console.error("‚ö†Ô∏è ID de sensor inv√°lido:", sensorId);
            return;
        }

        const chartId = `sensor-${sensorId}-${tipo}`;
        if (document.getElementById(chartId)) return; // Evitar duplicados

        let container = document.getElementById("graficos");
        if (!container) {
            console.error("‚ö†Ô∏è ERROR: No se encontr√≥ el contenedor de gr√°ficos en el DOM.");
            return;
        }

        // Crear el contenedor del gr√°fico
        const div = document.createElement('div');
        div.classList.add('chart-box');
        div.innerHTML = `<h2>Sensor ${sensorId} - ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</h2>
                         <canvas id="${chartId}"></canvas>`;
        container.appendChild(div);

        // Configuraci√≥n del gr√°fico
        const ctx = document.getElementById(chartId).getContext('2d');
        sensores[chartId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: tipo === 'temperatura' ? 'Temperatura (¬∞C)' : 'Humedad (%)',
                    data: [],
                    borderColor: tipo === 'temperatura' ? '#ff7043' : '#42a5f5',
                    backgroundColor: tipo === 'temperatura' ? 'rgba(255, 112, 67, 0.2)' : 'rgba(66, 165, 245, 0.2)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                        },
                        title: { display: true, text: 'Tiempo', color: '#ffffff' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: tipo === 'temperatura' ? 'Temperatura (¬∞C)' : 'Humedad (%)', color: '#ffffff' }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#ffffff' } }
                }
            }
        });
    }

    function iniciarWebSocket() {
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            console.log("üì° Conectado a WebSocket!");

            stompClient.subscribe('/topic/datos', function (message) {
                try {
                    console.log("üì© Mensaje recibido:", message.body);
                    const data = JSON.parse(message.body);

                    // Verificar si los datos tienen las propiedades necesarias
                    if (!data.idDispositivo || !data.temperatura || !data.humedad) {
                        console.error("‚ö†Ô∏è Error: Datos de sensor incompletos", data);
                        return;
                    }

                    const fecha = luxon.DateTime.fromFormat(data.fechaGeneracion, "dd/MM/yyyy HH:mm:ss").toJSDate();

                    let container = document.getElementById("graficos");
                    if (!container) {
                        console.error("‚ö†Ô∏è ERROR: No se encontr√≥ el contenedor de gr√°ficos en el DOM.");
                        return;
                    }

                    // Crear gr√°ficos si no existen
                    crearGrafico(data.idDispositivo, 'temperatura');
                    crearGrafico(data.idDispositivo, 'humedad');

                    // Obtener gr√°ficos creados
                    const tempChart = sensores[`sensor-${data.idDispositivo}-temperatura`];
                    const humChart = sensores[`sensor-${data.idDispositivo}-humedad`];

                    if (tempChart && humChart) {
                        tempChart.data.labels.push(fecha);
                        tempChart.data.datasets[0].data.push(data.temperatura);
                        tempChart.update();

                        humChart.data.labels.push(fecha);
                        humChart.data.datasets[0].data.push(data.humedad);
                        humChart.update();
                    } else {
                        console.error("‚ö†Ô∏è No se encontraron gr√°ficos para el sensor", data.idDispositivo);
                    }
                } catch (error) {
                    console.error("‚ùå Error procesando mensaje WebSocket:", error);
                }
            });
        });
    }
</script>


</body>
</html>
